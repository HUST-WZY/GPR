# 深度学习工作站操作指南

2020 年 11 月 30 日，谷歌旗下人工智能技术公司 DeepMind 提出的深度学习算法「Alphafold」破解了出现五十年之久的蛋白质分子折叠问题。这是继「AlphaGo」、「AlphaZero」之后，深度学习领域又一次吸引了全球目光的突破。

如今，深度学习如日中天，其在工业领域的应用方兴未艾。为此，我们搭建了本实验室的深度学习工作站，并编写了本指南。

感谢CL老师提供资金支持，感谢GNH、GFX同学提供技术、测试支持。

本指南由王子垚编写，**仅面向深度学习相关工作**。其中，工作站指位于实验室的电脑；`PC`指用于远程连接工作站的个人电脑，并且默认`PC`的操作系统为`windows10`；管理员暂指XXX。

只要实验室不停电，本工作站会保持在线，欢迎大家使用。

> **请按照本指南中的方法操作，如果需要执行额外的操作，或执行遇到问题，请先与管理员联系！**

## 1 工作站配置

### 1.1 硬件设备

|  设备  |                             型号                             |
| :----: | :----------------------------------------------------------: |
| 处理器 |             英特尔 Core i7-10700K @ 3.80GHz 八核             |
|  主板  |    华硕 TUF GAMING Z490-PLUS（LPC Controller Z490芯片组）    |
|  显卡  |          Nvidia GeForce RTX 3080 ( 10 GB / 七彩虹 )          |
|  内存  |                16 GB ( 海盗船 DDR4 3600MHz )                 |
|  硬盘  | 西数 WDS100T3X0C-00SJG0 ( 1 TB / 固态硬盘 )、西数 WDC WD20EZAZ-00GGJB0（2 TB / 机械硬盘） |
|  网卡  |          英特尔 Ethernet Connection  I219-V / 华硕           |

### 1.2 软件环境

工作站目前只配置了基于`pytorch`的深度学习环境，已经能满足绝大多数学术相关的深度学习工作，具体环境参数如下表所示。如需配置新的深度学习框架，请与管理员联系；如需安装新的`python`包，请参考第 4.2.1 节的命令。

|   软件   |  版本  |
| :------: | :----: |
| anaconda | 4.5.4  |
|  python  | 3.6.12 |
| pytorch  | 1.7.0  |
|   cuda   |  11.0  |
| gpytorch | 1.3.0  |

## 2 配置局域网

远程连接工作站需要将`PC`与工作站置于同一局域网环境中。我们使用虚拟局域网软件  [ZeroTier](www.zerotier.com) 来配置局域网。

### 2.1 准备软件

访问网站 `www.zerotier.com`，点击 `Download now`，跳转到下载页面，再点击微软图标即可下载。

<img src=".\res\微信截图_20201207135726.png" style="zoom: 25%;" />

<img src=".\res\微信截图_20201207182941.png" style="zoom: 25%;" />

下载完成后，打开点击 `next` 等待即可安装成功。

<img src=".\res\微信截图_20201207135924.png" style="zoom: 33%;" />

### 2.2 加入局域网

运行安装好的`ZeroTier`，软件会出现在右下角

<img src=".\res\微信截图_20201207140139.png" style="zoom:50%;" />

右键单击软件图标，下拉菜单选择`Join Network`，在弹出对话框中，输入`93afae596354904f`，并勾选`Allow Managed`，点击`Join`，如下图所示。

<img src=".\res\微信截图_20201207140354.png" style="zoom:50%;" />

之后屏幕右侧会出现蓝色的对话框，点击`是`（“网络”后的数字不一定是“11”）。

<img src=".\res\微信截图_20201207140646.png" style="zoom:50%;" />

> **完成后请联系管理员。管理员会将用户的`PC`加入虚拟局域网，同时在服务器上进行相应的配置。**

上述是第一次加入局域网的方法。之后软件会自动记住以加入的局域网的相关信息，第二次及之后加入只需点击下图中的红框使前面出现对号即可（事实上只要把软件打开就会自动加入上一次加入的局域网）。

<img src=".\res\微信截图_20201207151743.png" style="zoom:50%;" />

### 2.3 测试

`PC`端打开命令行，输入命令`ipconfig`，看到如下信息即为加入局域网成功，其中红色部分为`PC`在局域网中的`IP`。

<img src=".\res\微信截图_20201207141432.png" style="zoom:50%;" />

## 3 配置SSH连接协议

`SSH`为建立在应用层基础上的安全协议。`SSH`是较可靠，专为远程登录会话和其他网络服务提供安全性的协议。

连接工作站的`PC`需要安装`OpenSSH客户端`，**最新的正版`win10`操作系统是默认安装了的**。请按照第 3.1 节验证`PC`是否已安装`OpenSSH客户端`，如已安装，直接阅读第 4 节；如未安装，按照第 3.2 节进行安装。

### 3.1 验证OpenSSH客户端

在`PC`命令行输入`ssh`，看到如下信息即为`OpenSSH客户端`已安装。

<img src=".\res\微信截图_20201207141835.png" style="zoom:50%;" />

### 3.2 安装OpenSSH客户端

依次点击：`开始` -- `设置` -- `应用` -- `可选功能` -- `添加功能`，如下

<img src=".\res\微信截图_20201207142600.png" style="zoom: 25%;" />

<img src=".\res\微信截图_20201207142614.png" style="zoom:25%;" />

<img src=".\res\微信截图_20201207142629.png" style="zoom:25%;" />

然后在下图的红色框中找到`OpenSSH客户端`，点击安装即可（由于我的电脑已经装了`OpenSSH客户端`，所以在红框中找不到它）。

<img src=".\res\微信截图_20201207142735.png" style="zoom:25%;" />

安装完成后，按照第 3.1 节的方法进行验证。

## 4 PC远程连接工作站

我们建议使用 [SecureCRT](https://www.vandyke.com/products/securecrt/) 等专业的 `SSH` 软件来连接工作站，如果不想下载的话，使用`PC`命令行也行。接下来展示`PC`命令行连接工作站的方法。

### 4.1 SSH连接

在`PC`命令行输入

```shell
ssh MLDL@192.168.191.114
```

首次输入，会出现如下的提示，输入`yes`即可

<img src=".\res\微信图片_20201207152435.png" style="zoom: 80%;" />

然后命令行提示输入密码，如下图。请输入用户`MLDL`的密码`。**注意这里输入的内容不会在屏幕显示，正确输入后敲回车即可。**

<img src=".\res\微信截图_20201207152729.png" style="zoom: 80%;" />

命令行提示符变成下图，即为连接成功。

<img src=".\res\微信截图_20201207170501.png" style="zoom:50%;" />

要断开连接，可以直接关掉，但最好是命令行输入`exit()`。

#### 4.1.1 命令行粘贴

进入到`SSH`的命令行后，“粘贴”不再是`ctrl + v`，我们设置一下：

* 在黑窗口的上面的白色的头部，右键选择属性

* 将下面的红色框中的对号勾上，确定。

  <img src=".\res\微信截图_20201207155444.png" style="zoom:50%;" />

* 所以“粘贴”是`ctrl + shift + v`

### 4.2 进入深度学习环境

`SSH`连接成功后，命令行执行代码：

```shell
d:\AlgsTool\anaconda\Scripts\activate.bat d:\AlgsTool\anaconda
conda activate pytorch
```

看到命令行提示符变成了下图红框中所示，其中的`pytorch`为当前的深度学习环境名。

<img src=".\res\微信截图_20201207170707.png" style="zoom:50%;" />

我们可以测试下`pytorch`环境（不喜欢测试的同学可以不测）：

首先命令行输入`python`

* 测试`pytorch`包

  命令行接着输入`import torch`

  看到如下图所示即为成功

  <img src=".\res\微信截图_20201207154824.png" style="zoom: 50%;" />

* 测试`GPU`是否可用

  命令行接着输入`torch.cuda.is_available()`，返回`true`即为可用。

#### 4.2.1 常用命令

环境测试好后，我们介绍一些在该环境下的常用命令

* 进入`python`编译环境

  ```shell
  python
  ```

* 退出`python`编译环境

  ```shell
  quit()
  ```

  接下来的命令都需要退出`python`编译环境后，在`pytorch`深度学习环境下执行。

* 查看当前环境中安装的代码包

  ```shell
  pip list
  ```

* 安装新的代码包（如安装`pandas`包）

  ```shell
  conda install pandas
  ```

## 5 案例

上述**第 2-4 节的配置完成后**，我们就可以远程访问深度学习工作站执行深度学习任务了。具体的操作流程为：

* 在本地`PC`端编写`python`代码，并调试
* 上传代码、数据到工作站指定目录
* 调用工作站的计算资源执行代码
* 从工作站下载执行结果到本地`PC`
* 删除上传到工作站的代码、数据

其中，**指定目录**是指：

我们会为每个申请深度学习环境的用户创建个人文件夹，结构为：

```
-G:
	-User
		-wzy
			-code
			-data
			-fig
		-gnh
			-code
			-data
			-fig
```

其中，`wzy`为一个用户文件夹，下面有三个文件夹：

* code：存放待执行的代码
* data：存放执行代码所需要的数据
* fig：存放代码执行结果的图片

管理员会为每个用户创建一个用户文件夹，用户只能对自己的文件夹进行读写操作。

接下来将结合实际例子展示。

> 例子中的用户为**wzy**，复现例子时，请按下面的描述操作；实际使用时，应将**wzy**换成自己的用户文件夹名。**工作站支持多用户同时连接使用，但硬件资源有限，尽量还是分时使用。**

### 5.1 编写代码

我们的[实例代码](https://github.com/HUST-WZY/GPR/blob/main/gpr_gpu.py)需要注意的地方有：

* 最开始`import`了一些包，请使用第 4.2.1 节中的命令确保深度学习环境`pytorch`中有这些包。
* 最末尾，将执行结果的图片保存在**指定目录**。
* 调试工作需要在`PC`端完成，**工作站不提供调试服务**。

请将代码保存在`PC`端的`d`盘的根目录下，命名为`gpr_gpu.py`，即它的路径为：`D:\gpr_gpu.py`

### 5.2 上传代码、数据

本例子中的数据是自动生成的，就不涉及上传数据，这里只演示上传代码的操作。

完成**第 2-3 节**的配置后，**打开一个新的 `PC` 命令行**，执行下面的命令，把`PC`上的`D:\gpr_gpu.py`上传到工作站`MLDL@192.168.191.114`的目录`G:\User\wzy\code\`。

```shell
scp D:\gpr_gpu.py MLDL@192.168.191.114:G:\User\wzy\code\
```

然后输入密码，同样它不会显示的，正确输入后回车就好。然后看到如下所示，即为上传成功。

![](.\res\微信截图_20201207170200.png)

### 5.3 执行代码

按照**第 4 节**的方法进入深度学习环境后，在命令行输入

```shell
python g:\User\wzy\code\gpr_gpu.py
```

回车，看到如下执行结果，同时生成的结果图片在工作站的路径为：`G:\User\wzy\fig\test.png`。

<img src=".\res\微信截图_20201207171446.png" style="zoom: 50%;" />

### 5.4 下载执行结果

我们把结果图片下载到`PC`查看。

**重新在`PC`打开一个命令行**，执行下面的命令，将工作站`MLDL@192.168.191.114`中的文件`G:\User\wzy\fig\test.png`下载到`PC`的`d`盘根目录下。

```shell
scp MLDL@192.168.191.114:G:\User\wzy\fig\test.png D:\
```

输入不会显示的密码，看到如下所示，即下载成功。

![](.\res\微信截图_20201207172240.png)

然后就能在 `PC`查看结果图。

<img src=".\res\微信截图_20201207172401.png" style="zoom:50%;" />

> 如果执行结果中有数据，或者要根据数据重新作图，请通过`python`代码将数据保存在工作站的`G:\User\wzy\data\`目录下，然后再将数据下载至`PC`。

### 5.5 删除上传的文件

由于工作站为实验室共享，不是个人独有，所以可以在使用完删掉上传至工作站的代码、数据以及结果图片。以下为如何删除上面的结果图片。

**按照第 4.1 节进行 `SSH` 连接**，或者**直接在代码执行完的命令行之后**，执行下面的代码，即可删除第 5.4 节生成的结果图。

```shell
del G:\User\wzy\fig\test.png
```



